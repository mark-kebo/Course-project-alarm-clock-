MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;processor    PIC16F877 
Warning[205]: Found directive in column 1. (include)
                      00002 include  <P16F877.INC> 
                      00001         LIST
                      00002 
                      00003 ;==========================================================================
                      00004 ; Build date : Jul 02 2017
                      00005 ;  MPASM PIC16F877 processor include
                      00006 ; 
                      00007 ;  (c) Copyright 1999-2017 Microchip Technology, All rights reserved
                      00008 ;==========================================================================
                      00009 
                      00541         LIST
Warning[205]: Found directive in column 1. (errorlevel)
                      00003 errorlevel   -302 
                      00004         ;  директивы  типа  контроллера,  под-
                      00005         ;ключения  заголовочного  файла  и  вы-
                      00006         ;вода сообщений об ошибках 
                      00007 #define   bank0  bcf STATUS,  RP0 
                      00008 #define   bank1  bsf STATUS,  RP0 
                      00009 ; директивы, позволяющие заменять в 
                      00010         ;теле  ПО  команды,  указанные  после 
                      00011         ;этой  директивы  (bcf  ,  bsf)  –  метками 
                      00012         ;bank0, bank1. Обратную замену произ-
                      00013         ;водит компилятор 
  00000020            00014 WAIT    equ   0x20 
  00000021            00015 IOBYTE  equ   0x21   
  00000022            00016 FLAG    equ   0x22 
  00000023            00017 TEMP    equ   0x23
  00000024            00018 ZNAK    equ   0x24 
  00000025            00019 BITCNT  equ   0x25 
  00000026            00020 fCOUNTER      equ       0x26 
  00000027            00021 fCOUNTER2    equ       0x27 
  00000028            00022 TEMPL           equ     0x28
  00000029            00023 TEMPH           equ 0x29
  0000002A            00024 TEMPHH          equ 0x2A
                      00025         ;вспомогательные  регистры,  назначе-
                      00026         ;ние которых приведено в комментариях 
  0002                00027         constant   DS = .2
  0002                00028         constant   RST = .2 
                      00029         ;  директивы,  ставящие в  соответствие 
                      00030         ;меткам DS  и  RST  значение  0.  Анало-
                      00031         ;гия директив equ для имен регистров. 
  0044                00032         constant        COVERT_T=0x44 
  00BE                00033         constant        READ_SCRP=0xBE 
  00CC                00034         constant        SKIP_ROM=0xCC 
                      00035         ;директивы  обозначения  команд  дат-
                      00036         ;чика, позволяющие в теле ПО исполь-
                      00037         ;зовать имена команд вместо их кодов 
                      00038 DQ_HIZ  macro    
                      00039         bank1    
                      00040         bsf   TRISD,  DS 
                      00041         bank0 
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00042         endm 
                      00043         ; тело макроса DQ_HIZ, начинается и 
                      00044         ;заканчивается  словами  macro  и  endm. 
                      00045         ;Макрос  при  компиляции  заменяется 
                      00046         ;«вложенным  в  него»  набором  команд 
                      00047         ;контроллера. В данном случае он кон-
                      00048         ;фигурирует контакт RD0 как входной. 
                      00049         ;При  входе  в  макрос  вначале  устанав-
                      00050         ;ливается первый банк памяти данных, 
                      00051         ;затем  конфигурируется  контакт  DS 
                      00052         ;порта D (а учитывая, что DS=0, то это 
                      00053         ;будет  контакт  RD0)  и  далее  восста-
                      00054         ;навливается  нулевой  банк  памяти. 
                      00055         ;Макрос используется как для перехода 
                      00056         ;контроллера  в  режим  чтения  линии, 
                      00057         ;так и для установки «1» на линии 
                      00058 DQ_LO  macro  
                      00059         bank1 
                      00060         bcf   TRISD,  DS 
                      00061         bank0 
                      00062         bcf   PORTD,  DS 
                      00063         endm 
                      00064         ;  аналогичный  макрос,  конфигури-
                      00065         ;рующий  DS  как  выход  и  устанавли-
                      00066         ;вающий на нем «0». Макрос использу-
                      00067         ;ется  для  формирования  отрицатель-
                      00068         ;ных импульсов разной длительности 
                      00069 wait  macro     time 
                      00070         movlw    (time/5)-1 
                      00071         movwf    WAIT 
                      00072         call    wait5u 
                      00073         endm 
                      00074         ;макрос паузы с именем wait. Особен-
                      00075         ;ность этого макроса состоит в том, что 
                      00076         ;у  него  имеется  параметр  –  time.  При 
                      00077         ;вызове  макроса  значение  параметра 
                      00078         ;указывается  после  имени  макроса  в 
                      00079         ;виде  целого  десятичного  числа  крат-
                      00080         ;ного  5  (в  данном  примере).  В  теле 
                      00081         ;макроса  это  число  подставляется  в 
                      00082         ;«переменную» time и далее использу-
                      00083         ;ется вычисленное значение (которое в 
                      00084         ;данном случае  выступает  в  роли  кон-
                      00085         ;станты, записываемой в W). Вместе с 
                      00086         ;процедурой  wait5u  длительность  за-
                      00087         ;держки,  обеспечиваемая  макросом 
                      00088         ;равна time микросекунд 
                      00089         org 0x0000 
0000   0183           00090         clrf STATUS 
0001   3000           00091         movlw 0x00 
0002   008A           00092         movwf PCLATH 
0003   2???           00093         goto begin 
                      00094         ;выбор нулевой страницы памяти ко-
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00095         ;манд и размещение на ней откомпили-
                      00096         ;рованного кода 
0004                  00097 begin       
0004   1683           00098         bank1  ; выбор первого банка памяти. Для вы-
                      00099         ;зова используется метка bank1, объяв-
                      00100         ;ленная выше директивой #define    
0005   308F           00101         movlw 0x8F 
0006   0081           00102         movwf OPTION_REG 
0007   0064           00103         clrwdt 
                      00104         ;установка  максимального  времени 
                      00105         ;срабатывания  сторожевого  таймера  и 
                      00106         ;его сброс 
0008   018B           00107         clrf INTCON 
0009   018C           00108         clrf PIE1 
000A   018D           00109         clrf PIE2 
                      00110         ;отключение  прерываний  и  их  обработки 
000B   3000           00111         movlw .0 
000C   0086           00112         movwf TRISB       
000D   0087           00113         movwf TRISC
000E   0089           00114         movwf TRISE
                      00115         ; конфигурирование  портов  В, С, Е 
000F   3001           00116         movlw 0x01 
0010   0088           00117         movwf TRISD 
                      00118         ;конфигурирование  RD0  как  входа 
                      00119         ;для  установки  на  нем  «1»  в  качестве 
                      00120         ;исходного  состояния  интерфейса  «1-Wire» 
0011   1283           00121         bank0
0012   0187           00122         clrf PORTC 
                      00123 ; подготовка к передаче команд на контроллер 
                      00124 ;HD путем установки RC0=0 
0013   3001           00125         movlw 0x01     
0014   2???           00126         call write 
0015   300F           00127         movlw 0x0f 
0016   2???           00128         call delay 
                      00129 ; передача команды Clear  Display для очистки 
                      00130 ;дисплея и установки счетчика адреса видеопа-
                      00131 ;мяти  на  нулевой  адрес  (первое  знакоместо  в 
                      00132 ;верхней строке), с необходимой задержкой 
0017   0064           00133         clrwdt 
0018   3038           00134         movlw 0x38       
0019   2???           00135         call write 
001A   300F           00136         movlw 0x0f 
001B   2???           00137         call delay 
                      00138  
                      00139 ; передача команды Function Set для установки 
                      00140 ;режима  2-х  строчного  индикатора,  размера 
                      00141 ;знакоместа 5х7 и 8 разрядной шины данных 
001C   3006           00142         movlw 0x06     
001D   2???           00143         call write 
001E   300F           00144         movlw 0x0f 
001F   2???           00145         call delay 
                      00146 ;передача  команды  Entry  Mode  Set  для  уста-
                      00147 ;новки режима увеличения счетчика адреса ви-
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00148 ;деопамяти, после каждой записи символа в нее, 
                      00149 ;при неподвижности видеопамяти относительно 
                      00150 ;индикатора 
0020   300C           00151         movlw 0x0c     
0021   2???           00152         call write 
0022   300F           00153         movlw 0x0f 
0023   2???           00154         call delay 
                      00155 ;  передача  команды  Display  ON/OFF  control 
                      00156 ;для включения дисплея с отключенным курсо-
                      00157 ;ром.  На  этом  этап инициализации дисплея за-
                      00158 ;кончен.  
                      00159 ;       movwf 0x22 
                      00160 ;       movlw b'00101101'   
                      00161 ;       movwf 0x23 
                      00162 ;       movlw b'11100011'   
                      00163 ;       movwf 0x7e 
                      00164 ;       movlw b'11100101'   
                      00165 ;       movwf 0x7f 
                      00166  
                      00167  
                      00168 ; Запись числа, соответствующего напряжению 
                      00169 ;с  термодатчика  при  50  С  в  0х22-ой  регистр 
                      00170 ;ОЗУ. Аналогично, для 6 градусов – в 0х23 ре-
                      00171 ;гистр и т.д. до 98 градусов в 0х7f –ой регистр. 
                      00172 ;Значения байтов взяты из Таблицы № 7 и опре-
                      00173 ;деляются  паспортными  данными  терморези-
                      00174 ;стора ТСП. 
0024   1407           00175         bsf PORTC,0  ; установка RC0=1, для последующей передачи 
                      00176 ;кодов символов первой строки на дисплей 
0025   3056           00177         movlw 0x56 
0026   2???           00178         call write 
0027   306F           00179         movlw 0x6f 
0028   2???           00180         call write 
0029   3072           00181         movlw 0x72 
002A   2???           00182         call write 
002B   306F           00183         movlw 0x6f
002C   2???           00184         call write 
002D   307A           00185         movlw 0x7a 
002E   2???           00186         call write 
002F   3068           00187         movlw 0x68 
0030   2???           00188         call write 
0031   3062           00189         movlw 0x62 
0032   2???           00190         call write 
0033   3069           00191         movlw 0x69 
0034   2???           00192         call write 
0035   3063           00193         movlw 0x63 
0036   2???           00194         call write 
0037   306B           00195         movlw 0x6b 
0038   2???           00196         call write 
0039   3069           00197         movlw 0x69 
003A   2???           00198         call write 
                      00199    
                      00200 ;  Вывод  на  дисплей  надписи  «Analog  input 
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00201 ;RE1»  в  1-ой  строке,  путем  последовательно 
                      00202 ;записи  в  дисплей  кодов  символов  0х41, 
                      00203 ;0х6е,....0х31, используя процедуру write.
                      00204 ; Это не команда для контроллера HD, поэтому 
                      00205 ;задержки здесь не нужны, счетчик адреса авто-
                      00206 ;матически  увеличивается  на  1  при  каждой  за-
                      00207 ;писи. 
                      00208  
                      00209 ; Для уменьшения занимаемого места команды 
                      00210 ;приведены попарно (movlw и call) слева напра-
                      00211 ;во сверху вниз. 
003B   0064           00212         clrwdt 
003C   1007           00213         bcf PORTC, 0 
003D   30C0           00214         movlw b'11000000' 
003E   2???           00215         call write 
                      00216 ; Установка RC0=0, для последующей передачи 
                      00217 ;команды  на  контроллер  HD.  Передается  ко-
                      00218 ;манда Set DDRAM address,  устанавливающая 
                      00219 ;счетчик  адреса  видеопамяти  на  начало  2-ой 
                      00220 ;строки:  ячейку  с  адресом  (0х40  =  0100  0000). 
                      00221 ;Это  необходимо  для  вывода  фразы  «TEM-
                      00222 ;PERATURA =» на второй строке индикатора. 
                      00223  
003F   1407           00224         bsf PORTC,0  ; установка RC0=1, для последующей передачи 
                      00225 ;кодов символов второй строки на дисплей. Об-
                      00226 ;ратите внимание на то, что нигде не требуется 
                      00227 ;изменения  банков  памяти: т.к. все регистры, с 
                      00228 ;которыми работает ПО, находятся в 0-ом бан-
                      00229 ;ке. 
0040   3054           00230         movlw 0x54 
0041   2???           00231         call write 
0042   3045           00232         movlw 0x45 
0043   2???           00233         call write 
0044   304D           00234         movlw 0x4d 
0045   2???           00235         call write 
0046   3050           00236         movlw 0x50 
0047   2???           00237         call write 
0048   3045           00238         movlw 0x45 
0049   2???           00239         call write 
004A   3052           00240         movlw 0x52 
004B   2???           00241         call write 
004C   3041           00242         movlw 0x41 
004D   2???           00243         call write 
004E   3054           00244         movlw 0x54 
004F   2???           00245         call write 
0050   3055           00246         movlw 0x55 
0051   2???           00247         call write 
0052   3052           00248         movlw 0x52 
0053   2???           00249         call write 
0054   3041           00250         movlw 0x41 
0055   2???           00251         call write 
0056   3020           00252         movlw 0x20 
0057   2???           00253         call write 
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00254  
0058   303D           00255         movlw 0x3d 
0059   2???           00256         call write 
005A   0064           00257         clrwdt 
                      00258  
                      00259  
                      00260 ;  Вывод  на  дисплей  надписи  «TEMPERA-
                      00261 ;TURA  =»  во  2-ой  строке,  путем  последова-
                      00262 ;тельно записи в дисплей кодов символов 0х54, 
                      00263 ;0х45,....0х3d, используя процедуру write. После 
                      00264 ;выполнения этих операций счетчик адреса ви-
                      00265 ;деопамяти  установится  на  14-ом  знакоместе 
                      00266 ;индикатора.  Это  не  команда  для  контроллера 
                      00267 ;HD,  поэтому  задержки  здесь  не  нужны.  Для 
                      00268 ;уменьшения занимаемого места команды при-
                      00269 ;ведены  попарно  (movlw  и  call)  слева  направо 
                      00270 ;сверху вниз. 
                      00271 
                      00272 
005B                  00273 START 
                      00274         ; метка начала опроса датчика 
005B   2???           00275         call ds_reset   ;  вызов  процедуры  инициализации датчика  
005C   1D22           00276         btfss FLAG,  RST  ; проверка ответил ли датчик. Бит RST 
                      00277         ;в  регистре  FLAG  устанавливается  в 
                      00278         ;«1» в теле процедуры ds_reset при ус-
                      00279         ;пешно  пройденной  инициализации 
                      00280         ;датчиком (см. п. 14.4) 
005D   2???           00281         goto START  ;  переход  сюда  осуществляется  при 
                      00282                 ;RST=0,  т.е.  при  отсутствии  ответа  от 
                      00283         ;датчика об успешно  пройденной  ини-
                      00284         ;циализации.  Поэтому  повторяем  про-
                      00285         ;цедуру инициализации 
005E   30CC           00286         movlw SKIP_ROM 
005F   2???           00287         call ds_write 
                      00288         ;датчик  прошел  инициализацию,  да-
                      00289         ;лее  в  соответствие  с  алгоритмом  рис. 
                      00290         ;105  на  него  отправляется  команда 
                      00291         ;SKIP ROM. Для передачи использует-
                      00292         ;ся процедура ds_write, а перед ней в W 
                      00293         ;записывается  константа 
                      00294         ;SKIP_ROM=0xCC 
0060   3044           00295         movlw COVERT_T 
0061   2???           00296         call ds_write  
                      00297         ;аналогично  отправляем  команду  на-
                      00298         ;чала измерения температуры 
0062                  00299 ds_convert_loop    ; метка начала ожидания ответа датчи-
                      00300                                         ;ка  об  окончании  процесса  измерения 
                      00301                                         ;(см. 14.5, рис. 106) 
                      00302         wait .50  ;  задержка  на  50  мкс  путем  вызова макроса wait с параметром 50 
0062   3009               M         movlw    (.50/5)-1  
0063   00A0               M         movwf    WAIT 
0064   2???               M         call    wait5u 
                      00303         DQ_LO 
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0065   1683               M         bank1 
0066   1108               M         bcf   TRISD,  DS 
0067   1283               M         bank0 
0068   1108               M         bcf   PORTD,  DS 
Warning[211]: Extraneous arguments on the line.
0069   0000           00304         nop nop nop nop nop 
                      00305         ; формирование 5-ти микросекундного 
                      00306         ;отрицательного  импульса.  Т.к.  «1» 
                      00307         ;«осталась»  на  RD0  после  выполнения 
                      00308         ;команды  CONVERT_T  (см.  описание 
                      00309         ;процедуры ds write) 
                      00310         DQ_HIZ  
006A   1683               M         bank1    
006B   1508               M         bsf   TRISD,  DS 
006C   1283               M         bank0 
Warning[211]: Extraneous arguments on the line.
006D   0000           00311         nop nop nop nop nop 
                      00312         ; переход в режим чтения (и ожидание 
                      00313         ;ответа от датчика через 5 мкс) 
006E   1D08           00314         btfss PORTD,DS  ; проверка ответа от датчика о том что 
                      00315         ;измерение завершено (DS = 1 ?) 
006F   2???           00316         goto ds_convert_loop  ; переход на эту команду происходит, 
                      00317         ;если  ответа  от  датчика  еще  нет.  Для 
                      00318         ;этого зацикливаем ожидание и повторяем запрос на датчик 
0070   2???           00319         call   ds_reset 
0071   30CC           00320         movlw   SKIP_ROM 
0072   2???           00321         call   ds_write 
0073   30BE           00322         movlw   READ_SCRP 
0074   2???           00323         call   ds_write 
                      00324         ;ответ от датчика о завершении изме-
                      00325         ;рения  температуры  получен.  Отправ-
                      00326         ;ляем  на  датчик  последовательность 
                      00327         ;команд  в  соответствие  с  алгоритмом 
                      00328         ;на  рис.  105.  После  приема  последней 
                      00329         ;команды,  датчик  готов  по  запросу 
                      00330         ;мастера  отправлять  на  него  2  байта 
                      00331         ;измеренной температуры 
0075   2???           00332         call   ds_read  ;  вызываем  процедуру  чтения  байта  в 
                      00333         ;результате  которой  датчик  начинает 
                      00334         ;побитно отправлять, а мастер - побит-
                      00335         ;но принимать байт значения измерен-
                      00336         ;ной  температуры.  В  результате  вы-
                      00337         ;полнения процедуры в W будет запи-
                      00338         ;сан принятый байт  значения температуры 
0076   00A3           00339         movwf    TEMP  ; переписываем его в РОН 
0077   2???           00340         call   ds_read  ;  читаем  байт  знака  измеренной  температуры 
0078   00A4           00341         movwf    ZNAK  ; переписываем его в РОН 
0079   2???           00342         call   ds_reset    ;  повторно  инициализируем  датчик, 
                      00343         ;фактически  это  процедура  сброса  для 
                      00344         ;повторного измерения, рекомендуемая 
                      00345         ;производителем 
                      00346         ;
007A   1283           00347         bank0
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

007B   1007           00348         bcf PORTC, 0 
007C   30CD           00349         movlw b'11001101' 
007D   2???           00350         call write 
                      00351         ; Передача команды установки счетчика адреса 
                      00352         ;видеопамяти  на  15-ую  позицию  2-ой  строки 
                      00353         ;(0х4Е = 0100 1110). На 14-ом знакоместе после 
                      00354         ;символа «=»останется пробел. 
007E   1407           00355         bsf PORTC, 0  ; установка RC0=1, для последующей передачи 
                      00356         ;кодов  символов  измеренной  температуры  на 
                      00357         ;дисплей
                      00358 
                      00359         ;movlw          .250
                      00360         ;movwf          TEMP
Message[305]: Using default destination of 1 (file).
007F   0CA3           00361         rrf             TEMP
0080                  00362 BinBCD                   
0080   0823           00363                 MOVF    TEMP,0
0081   01A8           00364                 CLRF    TEMPL           ;чистим
0082   01A9           00365                 CLRF    TEMPH           ;
0083   01AA           00366                 CLRF    TEMPHH          ;
0084                  00367 Again1
0084   3E9C           00368         addlw   0x9C    ;вычитаем 100 и проверяем на займ
0085   1C03           00369         btfss   STATUS, C        
0086   2???           00370         goto    add100   
0087   0AAA           00371         incf    TEMPHH, f
0088   2???           00372         goto    Again1
0089                  00373 add100   
0089   3E64           00374         addlw   0x64
008A                  00375 Again
008A   3EF6           00376         addlw   0xF6    ;вычитаем 10 и проверяем на займ
008B   1C03           00377         btfss   STATUS, C        
008C   2???           00378         goto    SwapBCD  
008D   0AA9           00379         incf    TEMPH, f
008E   2???           00380         goto    Again
                      00381                          
008F                  00382 SwapBCD
008F   3E0A           00383         addlw   0x0A     
0090   0EA8           00384         swapf   TEMPL, f   
0091   04A8           00385         iorwf   TEMPL, f 
                      00386 
0092   3030           00387         movlw   0x30 
0093   042A           00388         iorwf   TEMPHH,0        
0094   2???           00389         call write      
0095   3030           00390         movlw   0x30 
0096   0429           00391         iorwf   TEMPH,0 
0097   2???           00392         call write  
0098   3030           00393         movlw   0x30 
0099   0428           00394         iorwf   TEMPL,0 
009A   2???           00395         call    write 
009B   2???           00396         goto   START  ; зацикливаем ПО для организации не-
                      00397         ;прерывного измерения температуры 
009C                  00398 wait5u:   
009C   0000           00399         nop 
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

009D   0064           00400         clrwdt 
009E   0BA0           00401         decfsz   WAIT,  F 
009F   2???           00402         goto   wait5u 
                      00403         ;процедура  задержки,  используемая 
                      00404         ;макросом  wait,  число  команд  которой 
                      00405         ;подобрано  таким  образом,  что  вместе 
                      00406         ;с  макросом  wait  обеспечивается  дли-
                      00407         ;тельность задержки time микросекунд 
00A0   0008           00408         return   
                      00409 
                      00410 
00A1                  00411 ds_read:    ; имя процедуры 
00A1   3008           00412         movlw   .8 
00A2   00A5           00413         movwf  BITCNT 
                      00414         ;установка счетчика числа не принятых бит 
00A3                  00415 dsr_loop    ; метка начала цикла последовательного приема 8-ми 
                      00416         ;бит команды 
00A3   0064           00417         clrwdt  ; сброс сторожевого таймера, т.к. длительность цикла 
                      00418         ;приема может превысить время срабатывания WDT 
                      00419         DQ_LO 
00A4   1683               M         bank1 
00A5   1108               M         bcf   TRISD,  DS 
00A6   1283               M         bank0 
00A7   1108               M         bcf   PORTD,  DS 
Warning[211]: Extraneous arguments on the line.
00A8   0000           00420         nop nop nop nop 
                      00421         ;вызов макроса перевода контакта RD0 в режим вы-
                      00422         ;хода и принудительной установки RD0 = «0». В дан-
                      00423         ;nop  ном  случае,  это  начало  формирования  5-ти  микросе-
                      00424         ;кундного  отрицательного  импульса  начала  приема 
                      00425         ;одного  бита.  Далее  приведена  условная  запись  5-ти 
                      00426         ;микросекундной задержки 
                      00427         DQ_HIZ  ; вызов макроса перевода контакта RD0 в режим вхо-
00A9   1683               M         bank1    
00AA   1508               M         bsf   TRISD,  DS 
00AB   1283               M         bank0 
                      00428         ;да.  В  данном  случае,  это  начало  ожидания  перед 
                      00429         ;приемом очередного бита данных от датчика 
Warning[211]: Extraneous arguments on the line.
00AC   0000           00430         nop  nop  nop  nop nop 
                      00431         ;задержка  на  5  мкс  для  момента  отсчета  реального 
                      00432         ;значения принимаемого бита данных от датчика 
00AD   0808           00433         movf  PORTD,  W  ; чтение порта (требуется только RD0) в W, в резуль-
                      00434         ;тате чего в младшем разряде W  оказывается приня-
                      00435         ;тый бит данных 
00AE   3904           00436         andlw b'00000100'  ;  умножение  содержимого  W  на  число  0000  0001,  в 
                      00437         ;результате чего все биты кроме младшего (в котором 
                      00438         ;хранится RD0) становятся равными 0. При этом в W 
                      00439         ;оказывается число 0000 000RD0 
00AF   3EFF           00440         addlw .255  ; арифметическое сложение содержимого W с числом 
                      00441         ;1111 1111. При этом результат операции контролиру-
                      00442         ;ется  битом  С  в  регистре  STATUS.  Причем  если 
                      00443         ;RD0=0, то результат сложения не равен 0, а следова-
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE 10


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00444         ;тельно бит С=0. Если же RD0=1, результат сложения 
                      00445         ;255+1=0,  что  приведет  к  установке  бита  С=1.  Таким 
                      00446         ;образом, в любом случае получаем С=RD0 
00B0   0CA1           00447         rrf   IOBYTE,   F  ;  сдвиг  вправо  регистра  IOBYTE  через  бит  С.  При 
                      00448         ;этом  значение  С=RD0  запишется  в  старший  разряд 
                      00449         ;IOBYTE, а при следующем сдвиге сдвинется вправо в 
                      00450         ;сторону младших разрядов и т.д.. Т.е. за 8 сдвигов в 
                      00451         ;этом регистре окажутся записанными все 8 принятых 
                      00452         ;с контакта RD0 битов данных с датчика 
                      00453         wait .50  ;  прием  бита  закончен,  выдерживаем  паузу  50  мкс 
00B1   3009               M         movlw    (.50/5)-1  
00B2   00A0               M         movwf    WAIT 
00B3   2???               M         call    wait5u 
                      00454         ;(через макрос задержки, описание которого приведено 
                      00455         ;в п.14.6), необходимую для приема следующего бита 
                      00456         ;данных 
00B4   0BA5           00457         decfsz  BITCNT,  F ; уменьшение числа не принятых бит на 1 и проверка 
                      00458         ;все ли 8 бит приняты. Если не все (следующая коман-
                      00459         ;да)  -  переходим  на  прием  следующего  бита.  Если 
                      00460         ;BITCNT=0,  пропустив  следующую  команду,  перепи-
                      00461         ;сываем принятый байт из IOBYTE в W 
00B5   2???           00462         goto    dsr_loop  ; метка перехода на прием следующего бита от датчика 
00B6   0821           00463         movf  IOBYTE,  W  ; прием окончен (приняты все 8 бит), поэтому резуль-
                      00464         ;тат перепишем в W 
00B7   0008           00465         return  ; выход из процедуры, при этом в W хранится принятый байт от датчика 
                      00466 
00B8                  00467 ds_write:   ; имя процедуры 
00B8   00A1           00468         movwf    IOBYTE  ; перезапись байта передаваемой команды во вспомо-
                      00469         ;гательный буферный регистр IOBYTE 
00B9   3008           00470         movlw  .8 
00BA   00A5           00471         movwf     BITCNT 
                      00472         ;установка счетчика числа не переданных бит 
00BB                  00473 dsw_loop    ; метка начала цикла последовательной передачи 8-ми бит команды 
00BB   0064           00474         clrwdt  ; сброс сторожевого таймера, т.к. длительность цикла 
                      00475         ;передачи может превысить время срабатывания WDT 
                      00476         DQ_LO  ; вызов макроса перевода контакта RD0 в режим вы-
00BC   1683               M         bank1 
00BD   1108               M         bcf   TRISD,  DS 
00BE   1283               M         bank0 
00BF   1108               M         bcf   PORTD,  DS 
                      00477         ;хода и принудительной установки RD0 = «0». В дан-
                      00478         ;ном  случае,  это  начало  формирования  5-ти  микросе-
                      00479         ;кундного  отрицательного  импульса  начала  передачи 
                      00480         ;одного бита 
Warning[211]: Extraneous arguments on the line.
00C0   0000           00481         nop nop nop nop nop 
                      00482         ;условная запись 5-ти микросекундной задержки (см. 
                      00483         ;предыдущую команду) 
00C1   0CA1           00484         rrf     IOBYTE, F  ; сдвиг буферного регистра IOBYTE вправо, при этом 
                      00485         ;его младший бит попадает в бит С регистра STATUS 
00C2   1803           00486         btfsc   STATUS, C  ; проверка чему равен этот бит. Если он равен «0», то 
                      00487         ;вызывается  макрос  задержки  на  60  мкс,  а  состояние 
                      00488         ;контакта  RD0=0  сохраняется.  При  этом  на  контакте 
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE 11


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00489         ;RD0 фактически формируется 60-ти микросекундное 
                      00490         ;значение младшего бита из регистра IOBYTE 
00C3   1508           00491         bsf    PORTD,  DS  ;  переход  сюда  осуществляется  при  С=1.  Так  «эта 
                      00492         ;единица» выставляется на RD0 
                      00493         wait .60  ; вызов макроса задержки на время (в мкс), указанное 
00C4   300B               M         movlw    (.60/5)-1  
00C5   00A0               M         movwf    WAIT 
00C6   2???               M         call    wait5u 
                      00494         ;после имени макроса. Описание тела макроса приве-
                      00495         ;дено в исходном коде основной программы в п. 14.6. 
                      00496         ;В  данном  случае  осуществляет  формирование  60-ти 
                      00497         ;микросекундного значения бита на контакте RD0
                      00498         DQ_HIZ  ; вызов макроса перевода контакта RD0 в режим вхо-
00C7   1683               M         bank1    
00C8   1508               M         bsf   TRISD,  DS 
00C9   1283               M         bank0 
                      00499         ;да и соответственно установки RD0 = «1». В данном 
                      00500         ;случае, это начало формирования 2-х микросекундной 
                      00501         ;ПАУЗЫ  перед  началом  передачи  следующего  бита 
                      00502         ;команды 
Warning[211]: Extraneous arguments on the line.
00CA   0000           00503         nop nop  ; пауза 2 мкс 
00CB   0BA5           00504         decfsz   BITCNT,  F  ;  уменьшение  на  1  счетчика  числа  уже  переданных 
                      00505         ;бит, с проверкой все ли 8 бит уже переданы 
00CC   2???           00506         goto    dsw_loop  ; зацикливание процедуры, т.к. переданные еще не все 8 бит 
00CD   0008           00507         return  ; выход из процедуры, т.к. переданы все 8 бит команды 
00CE                  00508 ds_reset:    ; имя процедуры инициализации датчика 
                      00509         DQ_HIZ  ; вызов макроса (специальным образом оформленная 
00CE   1683               M         bank1    
00CF   1508               M         bsf   TRISD,  DS 
00D0   1283               M         bank0 
                      00510         ;процедура) перевода контакта RD0 в режим входа для обеспечения RD0 = «1». Описание тела макроса
                             при-
                      00511         ;ведено  в  исходном  коде  основной  программы  в  п. 
                      00512         ;14.6. Фактически макрос конфигурирует этот контакт 
                      00513         ;как входной через регистр TRISD. Используются для 
                      00514         ;сокращения синтаксиса ПО 
00D1   1122           00515         bcf   FLAG,  RST  ; обнуление флага ответа датчика в регистре FLAG 
                      00516         DQ_LO  ; вызов макроса перевода контакта RD0 в режим вы-
00D2   1683               M         bank1 
00D3   1108               M         bcf   TRISD,  DS 
00D4   1283               M         bank0 
00D5   1108               M         bcf   PORTD,  DS 
                      00517         ;хода и установки RD0 = «0». Описание тела макроса 
                      00518         ;приведено в исходном коде основной программы в п. 
                      00519         ;14.6. Фактически макрос конфигурирует этот контакт 
                      00520         ;как  выходной  через  регистр  TRISD  и  устанавливает 
                      00521         ;на  нем  «0»  стандартным  образом.  В  данном  случае 
                      00522         ;это  начало  формирования  отрицательного  импульса 
                      00523         ;инициализации датчика длительностью 500 мкс 
                      00524         wait  .500  ; вызов макроса задержки на 500 мкс для формирова-
00D6   3063               M         movlw    (.500/5)-1 
00D7   00A0               M         movwf    WAIT 
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE 12


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00D8   2???               M         call    wait5u 
                      00525         ;ния отрицательного импульса инициализации в соот-
                      00526         ;ветствие с рис. 101. Описание тела макроса приведено 
                      00527         ;в теле основной программы в п. 14.6 
                      00528         DQ_HIZ  ; переходим к ожиданию ответа от датчика, переводя 
00D9   1683               M         bank1    
00DA   1508               M         bsf   TRISD,  DS 
00DB   1283               M         bank0 
                      00529         ;контакт  RD0  в  режим  входа.  Но  читаем  состояние 
                      00530         ;контакта только через 70 мкс (см. сл. команду) 
                      00531         wait   .70  ; выдерживаем паузу 70 мкс, для ожидания ответа от 
00DC   300D               M         movlw    (.70/5)-1  
00DD   00A0               M         movwf    WAIT 
00DE   2???               M         call    wait5u 
                      00532         ;датчика, путем вызова макроса задержки 
00DF   1D08           00533         btfss  PORTD,  DS  ;  проверяем  состояние  контакта  RD0.  Если  RD0=1 
                      00534         ;(т.е.  датчик  не  ответил  о  готовности  к  обмену),  то 
                      00535         ;следующая команда пропускается, и, после задержки 
                      00536         ;400 мкс (необходимой в соответствие с рис. 101), вы-
                      00537         ;ходим  из  процедуры  ds_reset  с  флагом  RST=0.  Если 
                      00538         ;же датчик в этот момент ответил RD0=0, то выполня-
                      00539         ;ется следующая команда и флаг RST устанавливается 
                      00540         ;в «1», говоря о наличие на линии готового к обмену 
                      00541         ;данными датчика типа DS1820 
00E0   1522           00542         bsf   FLAG,  RST  ; установка флага успешной инициализации датчика 
                      00543         wait  .400  ; задержка на 400 мкс, необходимая в соответствие со 
00E1   304F               M         movlw    (.400/5)-1 
00E2   00A0               M         movwf    WAIT 
00E3   2???               M         call    wait5u 
                      00544         ;спецификацией интерфейса «1-Wire» для осуществле-
                      00545         ;ния следующей попытки инициализации или продол-
                      00546         ;жения работы с датчиком 
00E4   0008           00547         return  ; выход из процедуры инициализации 
                      00548 
00E5                  00549 write    ; процедура записи байта к контроллер HD 
00E5   1303           00550         bcf STATUS, RP1 
00E6   1283           00551         bcf STATUS, RP0 
00E7   0086           00552         movwf PORTB 
00E8   1507           00553         bsf PORTC, 2 
00E9   3001           00554         movlw 0x01 
00EA   2???           00555         call delay 
00EB   1107           00556         bcf PORTC, 2 
00EC   0008           00557         return 
                      00558         ; перед вызовом этой процедуры в W помеща-
                      00559         ;ется байт, который надо записать в HD. Далее 
                      00560         ;он передается в PORTB и формируется отрица-
                      00561         ;тельный перепад на RC2, путем предваритель-
                      00562         ;ной  его  установки  в  «1»,  удержания  этого 
                      00563         ;уровня в течение некоторого времени (опреде-
                      00564         ;ляемого временем задержки delay  при  W=1) и 
                      00565         ;сброса его в «0». 
                      00566 
                      00567    ;  процедура  задержки,  время  которой  можно 
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE 13


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00568         ;регулировать, задавая число в W 
00ED                  00569 delay 
00ED   1303           00570         bcf   STATUS, RP1 
00EE   1283           00571         bcf   STATUS, RP0 
00EF   00A7           00572         movwf   fCOUNTER2 
00F0   01A6           00573         clrf    fCOUNTER 
00F1                  00574 BD_Loop    
00F1   0064           00575         clrwdt 
00F2   0BA6           00576         decfsz  fCOUNTER, f 
00F3   2???           00577         goto    BD_Loop 
00F4   0BA7           00578         decfsz  fCOUNTER2, f 
00F5   2???           00579         goto    BD_Loop 
00F6   0008           00580         return 
                      00581 
Warning[205]: Found directive in column 1. (end)
                      00582 end  ; конец программы 
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE 14


SYMBOL TABLE
  LABEL                             VALUE 

ACKDT                             00000005
ACKEN                             00000004
ACKSTAT                           00000006
ADCON0                            0000001F
ADCON1                            0000009F
ADCS0                             00000006
ADCS1                             00000007
ADDEN                             00000003
ADFM                              00000007
ADIE                              00000006
ADIF                              00000006
ADON                              00000000
ADRESH                            0000001E
ADRESL                            0000009E
Again                             0000008A
Again1                            00000084
BCLIE                             00000003
BCLIF                             00000003
BD_Loop                           000000F1
BF                                00000000
BITCNT                            00000025
BRGH                              00000002
BinBCD                            00000080
C                                 00000000
CCP1CON                           00000017
CCP1IE                            00000002
CCP1IF                            00000002
CCP1M0                            00000000
CCP1M1                            00000001
CCP1M2                            00000002
CCP1M3                            00000003
CCP1X                             00000005
CCP1Y                             00000004
CCP2CON                           0000001D
CCP2IE                            00000000
CCP2IF                            00000000
CCP2M0                            00000000
CCP2M1                            00000001
CCP2M2                            00000002
CCP2M3                            00000003
CCP2X                             00000005
CCP2Y                             00000004
CCPR1                             00000015
CCPR1H                            00000016
CCPR1L                            00000015
CCPR2                             0000001B
CCPR2H                            0000001C
CCPR2L                            0000001B
CHS0                              00000003
CHS1                              00000004
CHS2                              00000005
CKE                               00000006
CKP                               00000004
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE 15


SYMBOL TABLE
  LABEL                             VALUE 

COVERT_T                          00000044
CREN                              00000004
CSRC                              00000007
D                                 00000005
DATA_ADDRESS                      00000005
DC                                00000001
DQ_HIZ                            
DQ_LO                             
DS                                00000002
D_A                               00000005
D_NOT_A                           00000005
EEADR                             0000010D
EEADRH                            0000010F
EECON1                            0000018C
EECON2                            0000018D
EEDATA                            0000010C
EEDATH                            0000010E
EEIE                              00000004
EEIF                              00000004
EEPGD                             00000007
F                                 00000001
FERR                              00000002
FLAG                              00000022
FSR                               00000004
GCEN                              00000007
GIE                               00000007
GO                                00000002
GO_DONE                           00000002
GO_NOT_DONE                       00000002
I2C_DATA                          00000005
I2C_READ                          00000002
I2C_START                         00000003
I2C_STOP                          00000004
IBF                               00000007
IBOV                              00000005
INDF                              00000000
INTCON                            0000000B
INTE                              00000004
INTEDG                            00000006
INTF                              00000001
IOBYTE                            00000021
IRP                               00000007
NOT_A                             00000005
NOT_ADDRESS                       00000005
NOT_BO                            00000000
NOT_BOR                           00000000
NOT_DONE                          00000002
NOT_PD                            00000003
NOT_POR                           00000001
NOT_RBPU                          00000007
NOT_RC8                           00000006
NOT_T1SYNC                        00000002
NOT_TO                            00000004
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE 16


SYMBOL TABLE
  LABEL                             VALUE 

NOT_TX8                           00000006
NOT_W                             00000002
NOT_WRITE                         00000002
OBF                               00000006
OERR                              00000001
OPTION_REG                        00000081
P                                 00000004
PCFG0                             00000000
PCFG1                             00000001
PCFG2                             00000002
PCFG3                             00000003
PCL                               00000002
PCLATH                            0000000A
PCON                              0000008E
PEIE                              00000006
PEN                               00000002
PIE1                              0000008C
PIE2                              0000008D
PIR1                              0000000C
PIR2                              0000000D
PORTA                             00000005
PORTB                             00000006
PORTC                             00000007
PORTD                             00000008
PORTE                             00000009
PR2                               00000092
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
PSPIE                             00000007
PSPIF                             00000007
PSPMODE                           00000004
R                                 00000002
RA0                               00000000
RA1                               00000001
RA2                               00000002
RA3                               00000003
RA4                               00000004
RA5                               00000005
RB0                               00000000
RB1                               00000001
RB2                               00000002
RB3                               00000003
RB4                               00000004
RB5                               00000005
RB6                               00000006
RB7                               00000007
RBIE                              00000003
RBIF                              00000000
RC0                               00000000
RC1                               00000001
RC2                               00000002
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE 17


SYMBOL TABLE
  LABEL                             VALUE 

RC3                               00000003
RC4                               00000004
RC5                               00000005
RC6                               00000006
RC7                               00000007
RC8_9                             00000006
RC9                               00000006
RCD8                              00000000
RCEN                              00000003
RCIE                              00000005
RCIF                              00000005
RCREG                             0000001A
RCSTA                             00000018
RD                                00000000
RD0                               00000000
RD1                               00000001
RD2                               00000002
RD3                               00000003
RD4                               00000004
RD5                               00000005
RD6                               00000006
RD7                               00000007
RE0                               00000000
RE1                               00000001
RE2                               00000002
READ_SCRP                         000000BE
READ_WRITE                        00000002
RP0                               00000005
RP1                               00000006
RSEN                              00000001
RST                               00000002
RX9                               00000006
RX9D                              00000000
R_NOT_W                           00000002
R_W                               00000002
S                                 00000003
SEN                               00000000
SKIP_ROM                          000000CC
SMP                               00000007
SPBRG                             00000099
SPEN                              00000007
SREN                              00000005
SSPADD                            00000093
SSPBUF                            00000013
SSPCON                            00000014
SSPCON2                           00000091
SSPEN                             00000005
SSPIE                             00000003
SSPIF                             00000003
SSPM0                             00000000
SSPM1                             00000001
SSPM2                             00000002
SSPM3                             00000003
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE 18


SYMBOL TABLE
  LABEL                             VALUE 

SSPOV                             00000006
SSPSTAT                           00000094
START                             0000005B
STATUS                            00000003
SYNC                              00000004
SwapBCD                           0000008F
T0CS                              00000005
T0IE                              00000005
T0IF                              00000002
T0SE                              00000004
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000010
T1INSYNC                          00000002
T1OSCEN                           00000003
T1SYNC                            00000002
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000012
TEMP                              00000023
TEMPH                             00000029
TEMPHH                            0000002A
TEMPL                             00000028
TMR0                              00000001
TMR0IE                            00000005
TMR0IF                            00000002
TMR1                              0000000E
TMR1CS                            00000001
TMR1H                             0000000F
TMR1IE                            00000000
TMR1IF                            00000000
TMR1L                             0000000E
TMR1ON                            00000000
TMR2                              00000011
TMR2IE                            00000001
TMR2IF                            00000001
TMR2ON                            00000002
TOUTPS0                           00000003
TOUTPS1                           00000004
TOUTPS2                           00000005
TOUTPS3                           00000006
TRISA                             00000085
TRISA0                            00000000
TRISA1                            00000001
TRISA2                            00000002
TRISA3                            00000003
TRISA4                            00000004
TRISA5                            00000005
TRISB                             00000086
TRISB0                            00000000
TRISB1                            00000001
TRISB2                            00000002
TRISB3                            00000003
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE 19


SYMBOL TABLE
  LABEL                             VALUE 

TRISB4                            00000004
TRISB5                            00000005
TRISB6                            00000006
TRISB7                            00000007
TRISC                             00000087
TRISC0                            00000000
TRISC1                            00000001
TRISC2                            00000002
TRISC3                            00000003
TRISC4                            00000004
TRISC5                            00000005
TRISC6                            00000006
TRISC7                            00000007
TRISD                             00000088
TRISD0                            00000000
TRISD1                            00000001
TRISD2                            00000002
TRISD3                            00000003
TRISD4                            00000004
TRISD5                            00000005
TRISD6                            00000006
TRISD7                            00000007
TRISE                             00000089
TRISE0                            00000000
TRISE1                            00000001
TRISE2                            00000002
TRMT                              00000001
TX8_9                             00000006
TX9                               00000006
TX9D                              00000000
TXD8                              00000000
TXEN                              00000005
TXIE                              00000004
TXIF                              00000004
TXREG                             00000019
TXSTA                             00000098
UA                                00000001
W                                 00000000
WAIT                              00000020
WCOL                              00000007
WR                                00000001
WREN                              00000002
WRERR                             00000003
Z                                 00000002
ZNAK                              00000024
_BODEN_OFF                        00003FBF
_BODEN_ON                         00003FFF
_BOREN_OFF                        00003FBF
_BOREN_ON                         00003FFF
_CONFIG                           00002007
_CPD_OFF                          00003FFF
_CPD_ON                           00003EFF
_CP_ALL                           00000FCF
MPASM 5.75                       FISH2_4.ASM   9-30-2017  22:12:32         PAGE 20


SYMBOL TABLE
  LABEL                             VALUE 

_CP_HALF                          00001FDF
_CP_OFF                           00003FFF
_CP_UPPER_256                     00002FEF
_DEBUG_OFF                        00003FFF
_DEBUG_ON                         000037FF
_DEVID1                           00002006
_FOSC_EXTRC                       00003FFF
_FOSC_HS                          00003FFE
_FOSC_LP                          00003FFC
_FOSC_XT                          00003FFD
_HS_OSC                           00003FFE
_IDLOC0                           00002000
_IDLOC1                           00002001
_IDLOC2                           00002002
_IDLOC3                           00002003
_LP_OSC                           00003FFC
_LVP_OFF                          00003F7F
_LVP_ON                           00003FFF
_PWRTE_OFF                        00003FFF
_PWRTE_ON                         00003FF7
_RC_OSC                           00003FFF
_WDTE_OFF                         00003FFB
_WDTE_ON                          00003FFF
_WDT_OFF                          00003FFB
_WDT_ON                           00003FFF
_WRT_ENABLE_OFF                   00003DFF
_WRT_ENABLE_ON                    00003FFF
_WRT_OFF                          00003DFF
_WRT_ON                           00003FFF
_XT_OSC                           00003FFD
__16F877                          00000001
add100                            00000089
bank0                             bcf STATUS,  RP0
bank1                             bsf STATUS,  RP0
begin                             00000004
delay                             000000ED
ds_convert_loop                   00000062
ds_read                           000000A1
ds_reset                          000000CE
ds_write                          000000B8
dsr_loop                          000000A3
dsw_loop                          000000BB
fCOUNTER                          00000026
fCOUNTER2                         00000027
wait                              
wait5u                            0000009C
write                             000000E5

Errors   :     0
Warnings :     9 reported,     0 suppressed
Messages :     1 reported,    16 suppressed

